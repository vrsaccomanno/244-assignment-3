---
title: "Assignment 3"
author: "Vienna Saccomanno"
date: "2/26/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Task 2: Truckee River Flow (2000-2016)

```{r packages, warning=FALSE, message=FALSE}
#Attached packages
library(tidyverse)
library(tseries)
library(forecast)
library(tmap)
library(sf)
library(leaflet)
library(ggrepel)
library(ggspatial)
library(RColorBrewer)
```

```{r data, warning=FALSE, message=FALSE}
#Load data
truckee<- read_csv("truckee_flow.csv")

#Convert data to time series data
truckee_ts<- ts(truckee$mean_va, frequency = 12, start = c(2000,1)) #Start in January, 2000
#truckee_ts
plot(truckee_ts)

#Decompse the time series
truckee_dc<-decompose(truckee_ts)
plot(truckee_dc)
```

###Task 2a. Description of the decomposed graphs
- The decomposed data show stationary, additive time series data with clear seasonality within each year.
- The overall trend seems to be decreasing over time, with no perceptible outliers in this dataset.
- There might be a longer (~5 year) trend beyond the normal seasonality, but it not easily discernable. 
- Based on the scale, residuals might be a big contributor (i.e. there is a lot of noise beyond seasonality)



###Task 2b. Forecasting for 5 years - exponential smoothing (Holt-Winters)
```{r forecast, warning=FALSE, message=FALSE}

truckee_hw<-HoltWinters(truckee_ts)
#truckee_hw

#Smoothing parameters:
 #alpha: 0.2418713
 #beta : 0
 #gamma: 0.3384547

plot(truckee_hw) #Original data with the predication on top to check model accuracy (not yet forecasting)

#Future forecasting with holtwinters

truckee_forecast<- forecast(truckee_hw, h=60) #forecasting for 5 years, 60 months
plot(truckee_forecast, xlab = "Year", ylab = "Mean Discharge Value", sub = "Exponential smoothing of predictions about the Truckee River's future discharge. Data:USGS")

#Check the distribution of residuals
hist(truckee_forecast$residuals) #look pretty normal
```

##Task 3: Mapping California's National Parks
```{r data2,  warning=FALSE, message=FALSE}

#Read in CA county data
ca_counties<- read_sf(".", layer= "california_county_shape_file")
st_crs(ca_counties)=4326

#plot(ca_counties)

```

```{r data3,  warning=FALSE, message=FALSE}
#read in park data
nps<- read_sf(".", layer="nps_boundary") %>% 
  filter(STATE=="CA") %>% 
  filter(UNIT_TYPE== "National Park") 
  
st_crs(nps)=4326
#View(nps)
```

```{r map,  warning=FALSE, message=FALSE}
#Map just CA's parks
ca_nps <- ca_counties %>% 
  st_join(nps) %>% 
  filter(PARKNAME !="NA")
View(ca_nps)

#ca_nps<- ca_nps[!duplicated(ca_nps$UNIT_NAME),]

ca_nps_points<- st_centroid(ca_nps)
ca_nps_points<- cbind(ca_nps, st_coordinates(st_centroid(ca_nps$geometry)))

ca_np_map <-ggplot()+
  geom_sf(data=ca_counties, fill = "wheat3", color="NA")+
  geom_sf(data= nps, fill="lemonchiffon4", color="NA")+
  geom_label_repel(data = ca_nps_points[c(1, 5, 9, 10, 13, 21, 20, 18),], aes(x=X, y=Y, label=UNIT_NAME), nudge_x = -1, nudge_y = 1)+
  xlab("")+
  ylab("")+
  coord_sf(datum=NA) 

ca_np_map

```

##Task 4: Lizards in Chihuahuan Desert

###Part 1. Do weights of male and female adult lizards trappt at site "CALI" differ significantly?

```{r loaddata4, warning=FALSE, message=FALSE}
#Load data. This dataset has missing information (likely MCAR or MAR). My approach will be listwise deletion because this is a large dataset (n=132 without missings)
lizards<- read_csv("lter_lizard_pitfall.csv") %>% 
  select(site, sex, weight) %>% 
  filter(site=="CALI") %>% 
  filter(sex %in% c("M","F")) %>% 
  filter(weight !=".") %>% 
  group_by(sex)

#Making weight numeric
lizards_weight<-mutate_at(lizards, vars(weight), as.numeric)

#Data exploration- data are NOT normally distributed and do not meet Student's T-test assumptions.
hist(lizards_weight$weight)
qqnorm(lizards_weight$weight) #Data does not look normal, BUT
length(lizards_weight$weight)

class(lizards$weight_f)
class(lizards_weight$sex)


#Mann -Whitney U / non-parametric test
#H0= ranks are equal
liz<-wilcox.test(weight ~ sex, data=lizards_weight, exact=FALSE)
liz

#W = 2255.5, p-value = 0.5844

```

####Task 4, question one conclusion:
- The results of the Mann-Whitney U test suggest that, if the null hypothesis is true, the probability that we would have taken two samples that are this different by random chance is 58.4%; therefore, it is unlikely that the weights of male and female lizards differ significantly.

###Part 2. Is there a significant difference in the proportion of adult male and female lizards with broken tails?

```{r loaddata4, warning=FALSE, message=FALSE}

#Load data. This dataset has missing information (likely MCAR or MAR). My approach will be listwise deletion because this is a large dataset (n=132 without missings)
lizard_tails<- read_csv("lter_lizard_pitfall.csv") %>% 
  select(site, sex, tail) %>% 
  filter(site=="CALI") %>% 
  filter(sex %in% c("B","W")) %>% 
  filter(weight !=".") %>% 
  group_by(sex)


```

